#include <Arduino.h>

const PROGMEM byte head_block[35] = {0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x3c, 0x5a, 0x00, 0x10, 0x50, 0x45, 0x45, 0x4b, 0x20, 0x20, 0x20, 0x20, 0x42, 0x41, 0x53, 0x00, 0xff, 0xff, 0x87};
//const PROGMEM byte head_block[35] = {0x4E, 0x49, 0x43, 0x4F, 0x4C, 0x48, 0x4F, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x3c, 0x5a, 0x00, 0x10, 0x50, 0x45, 0x45, 0x4b, 0x20, 0x20, 0x20, 0x20, 0x42, 0x41, 0x53, 0x00, 0xff, 0xff, 0x87};
const PROGMEM byte block0[275] = {0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x3c, 0x5a, 0x01, 0x00, 0x31, 0x20, 0x27, 0x20, 0x50, 0x65, 0x65, 0x6b, 0x20, 0x6d, 0x65, 0x6d, 0x6f, 0x69, 0x72, 0x65, 0x0d, 0x32, 0x20, 0x27, 0x20, 0x4c, 0x69, 0x76, 0x72, 0x65, 0x20, 0x22, 0x4c, 0x61, 0x20, 0x66, 0x61, 0x63, 0x65, 0x20, 0x63, 0x61, 0x63, 0x68, 0x65, 0x65, 0x20, 0x64, 0x75, 0x20, 0x4d, 0x4f, 0x35, 0x22, 0x0d, 0x33, 0x20, 0x27, 0x20, 0x64, 0x65, 0x20, 0x4a, 0x65, 0x61, 0x6e, 0x2d, 0x42, 0x61, 0x70, 0x74, 0x69, 0x73, 0x74, 0x65, 0x20, 0x54, 0x6f, 0x75, 0x63, 0x68, 0x61, 0x72, 0x64, 0x2c, 0x20, 0x31, 0x39, 0x38, 0x35, 0x0d, 0x34, 0x20, 0x27, 0x20, 0x76, 0x6f, 0x69, 0x72, 0x20, 0x70, 0x61, 0x67, 0x65, 0x20, 0x34, 0x35, 0x0d, 0x35, 0x20, 0x27, 0x0d, 0x35, 0x20, 0x48, 0x58, 0x24, 0x3d, 0x22, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x22, 0x0d, 0x31, 0x30, 0x20, 0x43, 0x4c, 0x53, 0x3a, 0x53, 0x43, 0x52, 0x45, 0x45, 0x4e, 0x20, 0x37, 0x2c, 0x30, 0x2c, 0x30, 0x0d, 0x32, 0x30, 0x20, 0x49, 0x4e, 0x50, 0x55, 0x54, 0x20, 0x22, 0x41, 0x64, 0x72, 0x65, 0x73, 0x73, 0x65, 0x20, 0x64, 0x65, 0x20, 0x64, 0x65, 0x62, 0x75, 0x74, 0x20, 0x3a, 0x20, 0x22, 0x3b, 0x20, 0x41, 0x24, 0x0d, 0x33, 0x30, 0x20, 0x41, 0x3d, 0x56, 0x41, 0x4c, 0x28, 0x41, 0x24, 0x29, 0x0d, 0x34, 0x30, 0x20, 0x43, 0x4c, 0x53, 0x3a, 0x53, 0x43, 0x52, 0x45, 0x45, 0x4e, 0x20, 0x37, 0x2c, 0x30, 0x2c, 0x30, 0x3a, 0x4c, 0x4f, 0x43, 0x41, 0x54, 0x45, 0x20, 0x30, 0x2c, 0x32, 0x0d, 0x35, 0x30, 0x20, 0x46, 0x4f, 0x52, 0x20, 0x4d, 0x3d, 0x41, 0x20, 0x54, 0x4f, 0x20, 0x41, 0x2b, 0x31, 0x35, 0x38, 0x20, 0x53, 0x54, 0xa1};
const PROGMEM byte block1[275] = {0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x3c, 0x5a, 0x01, 0x00, 0x45, 0x50, 0x20, 0x38, 0x0d, 0x35, 0x35, 0x20, 0x5a, 0x3d, 0x4d, 0x3a, 0x47, 0x4f, 0x53, 0x55, 0x42, 0x20, 0x31, 0x30, 0x30, 0x30, 0x3a, 0x4d, 0x24, 0x3d, 0x5a, 0x24, 0x0d, 0x36, 0x30, 0x20, 0x49, 0x46, 0x20, 0x4c, 0x45, 0x4e, 0x28, 0x4d, 0x24, 0x29, 0x3c, 0x34, 0x20, 0x54, 0x48, 0x45, 0x4e, 0x20, 0x4d, 0x24, 0x3d, 0x22, 0x30, 0x22, 0x2b, 0x4d, 0x24, 0x3a, 0x47, 0x4f, 0x54, 0x4f, 0x20, 0x36, 0x30, 0x0d, 0x36, 0x35, 0x20, 0x43, 0x4f, 0x4c, 0x4f, 0x52, 0x20, 0x37, 0x2c, 0x30, 0x0d, 0x36, 0x36, 0x20, 0x50, 0x52, 0x49, 0x4e, 0x54, 0x20, 0x4d, 0x24, 0x3b, 0x22, 0x20, 0x22, 0x3b, 0x0d, 0x37, 0x30, 0x20, 0x44, 0x24, 0x3d, 0x22, 0x22, 0x0d, 0x37, 0x35, 0x20, 0x46, 0x4f, 0x52, 0x20, 0x4d, 0x31, 0x3d, 0x30, 0x20, 0x74, 0x6f, 0x20, 0x37, 0x0d, 0x38, 0x30, 0x20, 0x44, 0x3d, 0x50, 0x45, 0x45, 0x4b, 0x28, 0x4d, 0x2b, 0x4d, 0x31, 0x29, 0x0d, 0x38, 0x35, 0x20, 0x44, 0x24, 0x3d, 0x44, 0x24, 0x2b, 0x43, 0x48, 0x52, 0x24, 0x28, 0x44, 0x29, 0x0d, 0x39, 0x30, 0x20, 0x5a, 0x3d, 0x44, 0x3a, 0x47, 0x4f, 0x53, 0x55, 0x42, 0x20, 0x31, 0x30, 0x30, 0x30, 0x3a, 0x4f, 0x24, 0x3d, 0x5a, 0x24, 0x0d, 0x39, 0x31, 0x20, 0x49, 0x46, 0x20, 0x4c, 0x45, 0x4e, 0x28, 0x4f, 0x24, 0x29, 0x3d, 0x31, 0x20, 0x54, 0x48, 0x45, 0x4e, 0x20, 0x4f, 0x24, 0x3d, 0x22, 0x20, 0x22, 0x2b, 0x4f, 0x24, 0x0d, 0x39, 0x32, 0x20, 0x50, 0x52, 0x49, 0x4e, 0x54, 0x20, 0x4f, 0x24, 0x3b, 0x22, 0x20, 0x22, 0x3b, 0x0d, 0x39, 0x35, 0x20, 0x4e, 0x45, 0x58, 0x54, 0x20, 0x4d, 0x31, 0x0d, 0x31, 0x30, 0x30, 0x20, 0x46, 0x4f, 0x52, 0x20, 0x49, 0x3d, 0x31, 0x20, 0x54, 0x4f, 0x42};
const PROGMEM byte block2[275] = {0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x3c, 0x5a, 0x01, 0x00, 0x20, 0x38, 0x0d, 0x31, 0x30, 0x35, 0x20, 0x44, 0x3d, 0x41, 0x53, 0x43, 0x28, 0x4d, 0x49, 0x44, 0x24, 0x28, 0x44, 0x24, 0x2c, 0x49, 0x2c, 0x31, 0x29, 0x29, 0x0d, 0x31, 0x31, 0x30, 0x20, 0x43, 0x4f, 0x4c, 0x4f, 0x52, 0x20, 0x37, 0x2c, 0x30, 0x0d, 0x31, 0x31, 0x35, 0x20, 0x49, 0x46, 0x20, 0x44, 0x3e, 0x31, 0x32, 0x37, 0x20, 0x54, 0x48, 0x45, 0x4e, 0x20, 0x44, 0x3d, 0x44, 0x2d, 0x31, 0x32, 0x38, 0x3a, 0x43, 0x4f, 0x4c, 0x4f, 0x52, 0x20, 0x36, 0x0d, 0x31, 0x32, 0x30, 0x20, 0x49, 0x46, 0x20, 0x44, 0x3c, 0x33, 0x32, 0x20, 0x54, 0x48, 0x45, 0x4e, 0x20, 0x44, 0x3d, 0x44, 0x2b, 0x36, 0x34, 0x3a, 0x43, 0x4f, 0x4c, 0x4f, 0x52, 0x20, 0x2c, 0x34, 0x0d, 0x31, 0x32, 0x35, 0x20, 0x50, 0x52, 0x49, 0x4e, 0x54, 0x20, 0x43, 0x48, 0x52, 0x24, 0x28, 0x44, 0x29, 0x3b, 0x0d, 0x31, 0x33, 0x30, 0x20, 0x4e, 0x45, 0x58, 0x54, 0x20, 0x49, 0x0d, 0x31, 0x34, 0x30, 0x20, 0x50, 0x52, 0x49, 0x4e, 0x54, 0x0d, 0x31, 0x35, 0x30, 0x20, 0x4e, 0x45, 0x58, 0x54, 0x20, 0x4d, 0x0d, 0x31, 0x36, 0x30, 0x20, 0x4b, 0x24, 0x3d, 0x49, 0x4e, 0x4b, 0x45, 0x59, 0x24, 0x0d, 0x31, 0x36, 0x31, 0x20, 0x4b, 0x24, 0x3d, 0x49, 0x4e, 0x4b, 0x45, 0x59, 0x24, 0x3a, 0x49, 0x46, 0x20, 0x4b, 0x24, 0x3d, 0x22, 0x22, 0x20, 0x54, 0x48, 0x45, 0x4e, 0x20, 0x31, 0x36, 0x31, 0x0d, 0x31, 0x36, 0x35, 0x20, 0x49, 0x46, 0x20, 0x4b, 0x24, 0x3d, 0x22, 0x41, 0x22, 0x20, 0x54, 0x48, 0x45, 0x4e, 0x20, 0x31, 0x30, 0x0d, 0x31, 0x37, 0x30, 0x20, 0x41, 0x3d, 0x41, 0x2b, 0x31, 0x36, 0x30, 0x3a, 0x47, 0x4f, 0x54, 0x4f, 0x20, 0x34, 0x30, 0x0d, 0x31, 0x30, 0x30, 0x30, 0x20, 0x27, 0x20, 0x74};
const PROGMEM byte block3[158] = {0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x3c, 0x5a, 0x01, 0x8b, 0x43, 0x6f, 0x6e, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6f, 0x6e, 0x20, 0x48, 0x45, 0x58, 0x24, 0x0d, 0x31, 0x30, 0x31, 0x30, 0x20, 0x5a, 0x31, 0x3d, 0x5a, 0x3a, 0x5a, 0x24, 0x3d, 0x22, 0x22, 0x0d, 0x31, 0x30, 0x31, 0x35, 0x20, 0x5a, 0x32, 0x3d, 0x49, 0x4e, 0x54, 0x28, 0x5a, 0x31, 0x2f, 0x31, 0x36, 0x29, 0x3a, 0x5a, 0x31, 0x3d, 0x5a, 0x31, 0x2d, 0x5a, 0x32, 0x2a, 0x31, 0x36, 0x0d, 0x31, 0x30, 0x32, 0x30, 0x20, 0x5a, 0x24, 0x3d, 0x4d, 0x49, 0x44, 0x24, 0x28, 0x48, 0x58, 0x24, 0x2c, 0x31, 0x2b, 0x5a, 0x31, 0x2c, 0x31, 0x29, 0x2b, 0x5a, 0x24, 0x0d, 0x31, 0x30, 0x34, 0x30, 0x20, 0x49, 0x46, 0x20, 0x5a, 0x32, 0x3e, 0x30, 0x20, 0x54, 0x48, 0x45, 0x4e, 0x20, 0x5a, 0x31, 0x3d, 0x5a, 0x32, 0x3a, 0x47, 0x4f, 0x54, 0x4f, 0x20, 0x31, 0x30, 0x31, 0x35, 0x0d, 0x31, 0x30, 0x34, 0x35, 0x20, 0x52, 0x45, 0x54, 0x55, 0x52, 0x4e, 0x0d, 0x03};
const PROGMEM byte end_block[21] = {0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x3c, 0x5a, 0xff, 0x02, 0x00};

#define BLOCKBUFLEN 320
#define LEDPIN       13
#define DATAOUT       3
#define MOTPIN        4

byte state = 0x00;

void waitus(long int duree) {
    long int depart = micros();
    while(micros()-depart<duree);
}

void toogle_dataout(void) {
  state ^= 0x01;
  digitalWrite(DATAOUT, state);
}

void read_block(byte *block, uint16_t len) {
  for(uint16_t i = 0; i < len; i++) {
    byte w = block[i];
    for(uint8_t j = 0; j < 8; j++) {
      toogle_dataout();
      waitus(395);
      if(w & 0x80) toogle_dataout();
      waitus(395);
      w <<= 1;
    }
  }
  toogle_dataout();
}


void setup() {
  byte blockbuf[BLOCKBUFLEN];

  pinMode(DATAOUT, OUTPUT);
  pinMode(LEDPIN, OUTPUT);
  pinMode(MOTPIN, INPUT_PULLUP);

  // the output DATAOUT must be set to
  // HIGH for the LEP to be detected
  state = 0x01;
  digitalWrite(DATAOUT, state);

  // wait for the MOTOR ON request from
  // the computer on pin MOTPIN
  while(digitalRead(MOTPIN) == HIGH);
  
  digitalWrite(LEDPIN, HIGH);

  delay(2000);

  memcpy_P(blockbuf, head_block, 35);
  read_block(head_block, 35);
  delay(2000);

  memcpy_P(blockbuf, block0, 275);
  read_block(block0, 275);

  memcpy_P(blockbuf, block1, 275);
  read_block(block1, 275);

  memcpy_P(blockbuf, block2, 275);
  read_block(block2, 275);

  memcpy_P(blockbuf, block3, 158);
  read_block(block3, 158);

  memcpy_P(blockbuf, end_block, 21);
  read_block(end_block, 21);
}

void loop() {
  digitalWrite(LEDPIN, LOW);
  delay(100);
  digitalWrite(LEDPIN, HIGH);
  delay(100);
}
